<template>
    <div >
        <div>                       
            <pre>{{ data}}dynamic</pre>
        </div>
        <div class="border " v-if="jsonschema">
            <SimpleAppJsonSchemaForm :schema="jsonschema" :data="data"  #default="o" >                                                        
            <Card>
                <template #header>Response</template>
                <template #content>
                <div >                                                            
                        <div v-for="field in Object.keys(jsonschema.properties ?? {} )" class="border p-2">                                      
                            <SimpleAppInput :setting="o.getField(`#/properties/${field}`)" 
                            :input-type="autoPickInput( field )"
                            v-model="data[field]" />                                         
                        </div>                                    
                </div>                                
                </template>
                <template #footer>
                    <Button class="btn-primary" @click="o.validate(validateCallBack)">{{ t('submit') }}</Button>
                    
                </template>
            </Card> 
            </SimpleAppJsonSchemaForm>                                

        </div>                                                   
        </div>
</template>
<script lang="ts" setup>
    import {UserTaskType,SimpleAppInputType} from '~/types'
    import type { JSONSchema7 }  from 'json-schema'
    const props = defineProps<{
        processName:string
        taskName:string
        jsonschema:JSONSchema7
        instanceData:any
    }>()
    // props.jsonschema.properties
    const modelValue = defineModel<any>({})
    const emit = defineEmits(['submit'])
    const validateCallBack = async (errors:any)=>{
        // console.log("After validate",result)
        if(!errors){
            emit('submit',modelValue)
        }
    }

    const autoPickInput = (field:string) =>{
    let setting :JSONSchema7= {type:'string'}
    
    if(props.jsonschema.properties && props.jsonschema.properties[field]){
        setting = props.jsonschema.properties[field] as JSONSchema7 //force type
    } 
               
    
    if(setting.type=='boolean'){
        return SimpleAppInputType.checkbox
    }if(setting.type=='number'){
        return SimpleAppInputType.number
    }
    else if(setting.enum){
        return SimpleAppInputType.select
    }
    else if(setting.type=='string'){
        return pickStringInput(setting)        
    }else{
        return SimpleAppInputType.text
    }
}

const pickStringInput = (setting:any) =>{
    switch(setting.format){
        case 'date':
            return SimpleAppInputType.date
        break;
        case 'textarea':
            return SimpleAppInputType.textarea
        break;
        case 'text':
        default:
            return SimpleAppInputType.text
        break;
    }
}
</script>